1. 新增 products 产品时，自动添加没有使用过的 jan_code， 自动添加没有使用过的gtin_code

JAN_CODE 处理逻辑：

1. 1138X2, 拆分成 1138 和 数量 2 。
2. 3400X3401, 需要分配一个新的 JAN_CODE 予之对应 。
3. 77778888, 不需要单独处理,直接当成一个JAN_CODE处理 。

```sql
SELECT ODC.JAN_CD AS jan_code, ODC.order_day AS order_date,SUM(ODC.AMOUNT) AS sale_count, SUM(ODC.AMOUNT_PRICE) AS sale_amount FROM ORDER_DETAILS_CALC ODC JOIN ORDERS O ON ODC.ORDER_NUMBER = O.ORDER_NUMBER
WHERE O.cancel_flag <> 2
GROUP BY ODC.JAN_CD,ODC.order_day
```

```sql
select cstocks.item_cd,csku.jan_code, cstocks.stock, cstocks.attribute1_name, cstocks.attribute2_name,odc.order_month,sum(odc.amount) as sale_count,sum(odc.amount_price) as sale_amount
from crossmall_item_stocks cstocks join crossmall_item_sku csku
on cstocks.item_cd = csku.item_code
and cstocks.attribute1_name = csku.attribute1_name
and cstocks.attribute2_name = csku.attribute2_name
and cstocks.stock>0
join order_details_calc odc on odc.jan_cd = csku.jan_code
join products p on odc.jan_cd = p.jan_code
where p.status = 1
-- where csku.jan_code = '2118'
group by cstocks.item_cd,csku.jan_code, cstocks.stock, cstocks.attribute1_name, cstocks.attribute2_name,odc.order_month
order by csku.jan_code , odc.order_month asc
```

商品别数据统计

```sql
select os.shop_name,os.shop_code,os.delivery_date, odc.item_code,sg.managenumber, sum(odc.amount_price) as amount_price,
sum(odc.amount) as amount,  sum(round((odc.amount_price / os.subtotal_price)* os.tax_total_price_10)) as tax_price,
sum(round((odc.amount_price / os.subtotal_price)* os.coupon)) as coupon,sum(round((odc.amount_price / os.subtotal_price)* os.point)) as point
from orders os join order_details_calc odc 
on os.order_number = odc.order_number
left join shop_good sg on odc.item_code = sg.itemnumber 
-- where os.delivery_date <= '2024-12-31' 
-- and os.delivery_date is not null 
and os.cancel_flag <> 2 
group by os.shop_name,os.delivery_date, odc.item_code,sg.managenumber,os.shop_code
order by delivery_date desc


SELECT effectdate,shopid,itemurl,sum(total720hcv) as total720hcv,sum(total720hgms) as total720hgms  
FROM report_goods
-- where effectdate = '2024-12-25' 
group by itemurl,shopid,effectdate
order by effectdate desc

```

```sql
-- 初始化 sales_summary 数据
INSERT INTO public.sales_summary(
 shopid, shop_name, shop_code, delivery_date, item_code, managenumber, amount_price, amount,
 tax_price, coupon, point, total720hcv, total720hgms)
select gss.shopid, os.shop_name,os.shop_code,os.delivery_date, odc.item_code,sg.manage_code as managenumber, 
 sum(odc.amount_price) as amount_price,
 sum(odc.amount) as amount,  
 sum(round((odc.amount_price / os.subtotal_price)* os.tax_total_price_10)) as tax_price,
 sum(round((odc.amount_price / os.subtotal_price)* os.coupon)) as coupon,
 sum(round((odc.amount_price / os.subtotal_price)* os.point)) as point,
 sum(rgs.total720hcv) as total720hcv,
 sum(rgs.total720hgms) as total720hgms  
 
 from orders os join order_details_calc odc 
 on os.order_number = odc.order_number
 join graceful_shops gss on os.shop_code = gss.shop_code
 left join itemcode_itemmanagecode_mapping sg on odc.item_code = sg.item_code 
 left join report_goods rgs 
 -- on rgs.effectdate = '2024-12-29' and 
 on rgs.periodtype = 0 and rgs.shopid = gss.shopid  and rgs.itemurl = sg.manage_code
 -- where os.delivery_date = '2024-12-29'
 -- and os.delivery_date is not null 
 and os.cancel_flag <> 2 
 group by gss.shopid, os.shop_name,os.delivery_date, odc.item_code,sg.manage_code,os.shop_code
```

```sql
--- 乐天市场销售数据分析

select 
    gss.shopid, 
    os.shop_code, 
    os.shop_name, 
    os.delivery_date, 
    odc.jan_cd,
    odc.item_code, 
    iim.manage_code, 
    os.order_code, 
    os.order_number,
    os.subtotal_price, 
    os.point,
    ROUND((odc.amount_price / os.subtotal_price) * os.coupon, 2) AS coupon,
    os.tax_total_price_10,
    ROUND((odc.amount_price / os.subtotal_price) * os.tax_total_price_10, 2) AS tax,
    odc.amount, 
    odc.amount_price,
    ROUND((odc.amount_price / os.subtotal_price) * aor.rewards, 2) AS rewards2,
    aor.rewards
from orders os 
join order_details_calc odc on os.order_number = odc.order_number 
join graceful_shops gss on os.shop_code = gss.shop_code 
left join itemcode_itemmanagecode_mapping iim on  odc.item_code = iim.item_code and iim.shop_code = os.shop_code
left join (
select sum(rewards) as rewards, oid from  afl_orders_report
group by oid
) as aor on os.order_code = aor.oid
where os.cancel_flag = 0 and phase_name = '完了' --and  os.delivery_date is not null
and gss.shop_platform = 1
-- and os.order_number = '01349009'

order by delivery_date desc
limit 1000
```

```sql
--au店 的优惠数据？
select option1_fee,coupon,total_price,subtotal_price,order_code,* from orders where option1_fee < 0
order by order_date desc
```

按月计算页面级别的数据

```sql
select A.*, 
COALESCE(B.total720hgms, 0) as total720hgms, 
COALESCE(B.total720hcv, 0) as total720hcv
,COALESCE(C.actual_amount, 0) as ca_actual_amount
,COALESCE(C.sales_count, 0) as ca_sales_count
,cafr.advertisingfees -- cpa数据，（为整月的支出数据）
,D.deal_sales_value -- DEAL 广告支出，（为整月的支出数据）
,E.rmail_chargefee -- 乐天的email 广告支出（为整月的支出数据）
,F.pointsawarded -- ポイント付与 （为整月的支出数据）
from 
(
 select
 gs.shopid
 ,gs.shop_code
 -- odc.shop_name, 
 ,TO_CHAR(os.delivery_date, 'YYYY-MM-01') AS year_month
 ,odc.item_code
 ,odc.manage_code
 ,sum(odc.amount_price) as amount_price -- 销量金额
 ,sum(odc.amount) as jan_count -- 所卖的jan code 数量
 -- count(distinct os.order_number) as order_count, -- 这个计算只会将一个订单号统计一次
 ,count( odc.order_number) as order_count -- 同一个订单号，在每个页面中都应进行统计，所以使用 count( odc.order_number)
 ,sum(odc.tax_price) as tax_price -- 消费税
 ,sum(odc.coupon) as coupon  -- 顾客使用的优惠券
 ,sum(odc.rewards) as afl_rewards -- 博主奖励
 ,count(distinct aor.oid) as afl_order_count -- 博主带货的订单数
 ,sum(odc.amount * odc.original_price) as total_orginal_price -- 原价之和
 ,sum(odc.shipping_cost + odc.envelope_cost) as  shipping_fee -- 运费之和
 from 
 graceful_shops gs  
 left join orders os 
  on gs.shop_code = os.shop_code  
  
  -- and os.delivery_date is not null
  and os.phase_name = '完了' 
  and os.cancel_flag = 0   
  and detail_downloaded=true
 left join order_details_calc odc 
  on odc.order_number = os.order_number
 left join public.afl_orders_report aor 
  on aor.oid = os.order_code 
 where odc.shop_platform = 1   -- 表示只处理乐天的  
 and  TO_CHAR(os.delivery_date, 'YYYY-MM-01') = '2024-12-01' 
 group by gs.shopid,gs.shop_code,odc.shop_name 
 ,odc.item_code,odc.manage_code
 ,TO_CHAR(os.delivery_date, 'YYYY-MM-01') 
) as A
left join 
(
  --- RPP 数据
 SELECT gs.shop_code
 , rgs.itemurl
 , TO_CHAR(rgs.effectdate, 'YYYY-MM-01') as year_month
 ,rgs.total720hgms  -- 売上金額 (合計720時間)
 ,rgs.total720hcv  -- 売上件数 (合計720時間)  
 FROM report_goods rgs 
 join graceful_shops gs on rgs.shopid = gs.shopid
 where  rgs.periodtype = 1 -- and gs.shop_code = '07' 
) as B
on A.shop_code = B.shop_code and A.manage_code = B.itemurl and A.year_month = B.year_month
left join 
(
-- CA 数据
select shopid
, itemmngid 
,TO_CHAR(startdate, 'YYYY-MM-01') as startdate
,actual_amount --実績額(CA)
,sales_count   --売上件数(CA)
from cpnadv_goods_report
where periodtype = 1 
) as C
on A.shopid=C.shopid and C.itemmngid = A.manage_code  and A.year_month = C.startdate
left join
cpa_advertising_fees_report cafr  -- CPA (使用的是按月数据，所以这里得到的值是整月的CPA数据)
on A.shopid=cafr.shopid and cafr.periodtype = 1  and TO_CHAR( cafr.effectdate, 'YYYY-MM-01') = A.year_month
left join 
(
-- DEAL
select shopid 
,TO_CHAR(effectdate, 'YYYY-MM-01') AS year_month
,COALESCE(sum(deal_sales_value ),0) as deal_sales_value
from rakuten_sales_indicators
where device_type = 10 and periodtype = 2
group by shopid,TO_CHAR(effectdate, 'YYYY-MM-01') 
) as D
on D.shopid = cafr.shopid and D.year_month = A.year_month
left join 
(
-- おニュ(店舗) 乐天的email 广告支出
select shopid  
,TO_CHAR(deliverydate, 'YYYY-MM-01') AS year_month
,sum(chargefee) as rmail_chargefee
from auto_rmail_report
where  reportfrequency = 2
group by shopid,TO_CHAR(deliverydate, 'YYYY-MM-01') 
) as E 
on E.shopid= cafr.shopid and E.year_month = A.year_month
left join 
(
-- ポイント付与
select 
shopid 
,TO_CHAR(effectdate, 'YYYY-MM-01') AS year_month
,sum(pointsawarded) as pointsawarded
from points_awarded  
group by shopid,TO_CHAR(effectdate, 'YYYY-MM-01')
) as F 
on F.shopid = cafr.shopid and F.year_month = A.year_month


```

初始化 sales_page_months_summary 数据

```sql
INSERT INTO sales_page_months_summary(
 shopid, shop_code, effect_month, item_code, manage_code, amount_price, jan_count, order_count, tax_price,
 coupon,  shipping_fee, afl_rewards, afl_order_count, total720hgms, total720hcv, ca_actual_amount, 
 ca_sales_count, advertisingfees, deal_sales_value, rmail_chargefee, pointsawarded)

select 
A.shopid, A.shop_code, TO_DATE(A.effect_month, 'YYYY-MM-DD'), A.item_code
, A.manage_code, A.amount_price, A.jan_count, A.order_count, A.tax_price, A.coupon
, A.shipping_fee, A.afl_rewards, A.afl_order_count, 
COALESCE(B.total720hgms, 0) as total720hgms, 
COALESCE(B.total720hcv, 0) as total720hcv
,COALESCE(C.actual_amount, 0) as ca_actual_amount
,COALESCE(C.sales_count, 0) as ca_sales_count
,cafr.advertisingfees -- cpa数据，（为整月的支出数据）
,D.deal_sales_value -- DEAL 广告支出，（为整月的支出数据）
,E.rmail_chargefee -- 乐天的email 广告支出（为整月的支出数据）
,F.pointsawarded -- ポイント付与 （为整月的支出数据）
from 
(
 select
 gs.shopid
 ,gs.shop_code
 -- odc.shop_name, 
 ,TO_CHAR(os.delivery_date, 'YYYY-MM-01') AS effect_month
 ,odc.item_code
 ,odc.manage_code
 ,sum(odc.amount_price) as amount_price -- 销量金额
 ,sum(odc.amount) as jan_count -- 所卖的jan code 数量
 -- count(distinct os.order_number) as order_count, -- 这个计算只会将一个订单号统计一次
 ,count( odc.order_number) as order_count -- 同一个订单号，在每个页面中都应进行统计，所以使用 count( odc.order_number)
 ,sum(odc.tax_price) as tax_price -- 消费税
 ,sum(odc.coupon) as coupon  -- 顾客使用的优惠券
 ,sum(odc.rewards) as afl_rewards -- 博主奖励
 ,count(distinct aor.oid) as afl_order_count -- 博主带货的订单数
 ,sum(odc.amount * odc.original_price) as total_orginal_price -- 原价之和
 ,sum(odc.shipping_cost + odc.envelope_cost) as  shipping_fee -- 运费之和
 from 
 graceful_shops gs  
 left join orders os 
  on gs.shop_code = os.shop_code  
  
  -- and os.delivery_date is not null
  and os.phase_name = '完了' 
  and os.cancel_flag = 0   
  and detail_downloaded=true
 left join order_details_calc odc 
  on odc.order_number = os.order_number
 left join public.afl_orders_report aor 
  on aor.oid = os.order_code 
 where odc.shop_platform = 1   -- 表示只处理乐天的  
 -- and  TO_CHAR(os.delivery_date, 'YYYY-MM-01') = '2024-12-01' 
 group by gs.shopid,gs.shop_code,odc.shop_name 
 ,odc.item_code,odc.manage_code
 ,TO_CHAR(os.delivery_date, 'YYYY-MM-01') 
) as A
left join 
(
  --- RPP 数据
 SELECT gs.shop_code
 , rgs.itemurl
 , TO_CHAR(rgs.effectdate, 'YYYY-MM-01') as effect_month
 ,rgs.total720hgms  -- 売上金額 (合計720時間)
 ,rgs.total720hcv  -- 売上件数 (合計720時間)  
 FROM report_goods rgs 
 join graceful_shops gs on rgs.shopid = gs.shopid
 where  rgs.periodtype = 1 -- and gs.shop_code = '07' 
) as B
on A.shop_code = B.shop_code and A.manage_code = B.itemurl and A.effect_month = B.effect_month
left join 
(
-- CA 数据
select shopid
, itemmngid 
,TO_CHAR(startdate, 'YYYY-MM-01') as startdate
,actual_amount --実績額(CA)
,sales_count   --売上件数(CA)
from cpnadv_goods_report
where periodtype = 1 
) as C
on A.shopid=C.shopid and C.itemmngid = A.manage_code  and A.effect_month = C.startdate
left join
cpa_advertising_fees_report cafr  -- CPA (使用的是按月数据，所以这里得到的值是整月的CPA数据)
on A.shopid=cafr.shopid and cafr.periodtype = 1  and TO_CHAR( cafr.effectdate, 'YYYY-MM-01') = A.effect_month
left join 
(
-- DEAL
select shopid 
,TO_CHAR(effectdate, 'YYYY-MM-01') AS effect_month
,COALESCE(sum(deal_sales_value ),0) as deal_sales_value
from rakuten_sales_indicators
where device_type = 10 and periodtype = 2
group by shopid,TO_CHAR(effectdate, 'YYYY-MM-01') 
) as D
on D.shopid = cafr.shopid and D.effect_month = A.effect_month
left join 
(
-- おニュ(店舗) 乐天的email 广告支出
select shopid  
,TO_CHAR(deliverydate, 'YYYY-MM-01') AS effect_month
,sum(chargefee) as rmail_chargefee
from auto_rmail_report
where  reportfrequency = 2
group by shopid,TO_CHAR(deliverydate, 'YYYY-MM-01') 
) as E 
on E.shopid= cafr.shopid and E.effect_month = A.effect_month
left join 
(
-- ポイント付与
select 
shopid 
,TO_CHAR(effectdate, 'YYYY-MM-01') AS effect_month
,sum(pointsawarded) as pointsawarded
from points_awarded  
group by shopid,TO_CHAR(effectdate, 'YYYY-MM-01')
) as F 
on F.shopid = cafr.shopid and F.effect_month = A.effect_month

```
